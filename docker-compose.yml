services:
  msut-auth-app:
    image: crpi-75lq6t3o28kvt0hk.cn-heyuan.personal.cr.aliyuncs.com/msut/msut-web:latest
    container_name: msut-auth-app
    security_opt:
      - label=disable
    ports:
      - "1122:80"
      - "3400:3400"
    environment:
      - NODE_ENV=production
      - PORT=3400
      - PYTHONPATH=/app
      - JWT_SECRET=${JWT_SECRET:-please-change-this-secret-in-production}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-http://localhost:1122}
      - HTTPS_ENABLED=${HTTPS_ENABLED:-false}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-}
      - DATA_DIR=/app/server/data
      - RAG_API_BASE=${RAG_API_BASE:-}
      - RAG_API_KEY=${RAG_API_KEY:-}
      - RAG_LLM_MODEL=${RAG_LLM_MODEL:-}
      - RAG_EMBED_MODEL=${RAG_EMBED_MODEL:-}
      - RAG_EMBED_DIM=${RAG_EMBED_DIM:-}
    volumes:
      - ./uploads:/app/server/uploads:rw
      - ./data:/app/server/data:rw
    restart: unless-stopped
    networks:
      - msut-network

    # --- 针对 2C2G 机器的极限配置 ---
    deploy:
      resources:
        limits:
          # CPU: 限制使用 1.8 核，预留 0.2 核给系统，防止 CPU 100% 时服务器失联
          cpus: '1.8'
          # 内存: 硬限制 1.5G。绝对不要超过 1.6G，必须给宿主机留 400M+ 救命
          memory: 1536M
        reservations:
          # 预留: 保证至少有 512M 可用才启动
          memory: 512M
    # -------------------------------

networks:
  msut-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1