services:
  msut-auth-app:
    image: crpi-75lq6t3o28kvt0hk.cn-heyuan.personal.cr.aliyuncs.com/msut/msut-web:latest
    container_name: msut-auth-app
    security_opt:
      - label=disable
    ports:
      - "1122:80"
      - "3400:3400"
    environment:
      - NODE_ENV=production
      - PORT=3400
      - PYTHONPATH=/app
      - JWT_SECRET=${JWT_SECRET:-please-change-this-secret-in-production}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-http://localhost:1122}
      - HTTPS_ENABLED=${HTTPS_ENABLED:-false}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-}
      - DATA_DIR=/app/server/data
    volumes:
      - ./uploads:/app/server/uploads:rw
      # Bind the whole data dir so SQLite can create the DB file inside it.
      # Binding a non-existent host file path (./data/data.sqlite) causes Docker
      # to mount a directory at the file path inside the container, making SQLite
      # fail with "unable to open database file" and uploads appear to succeed
      # but metadata insertions fail.
      - ./data:/app/server/data:rw
    restart: unless-stopped
    networks:
      - msut-network

networks:
  msut-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
